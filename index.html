<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEON DUEL: SMOOTH V2</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; background: #050505; overflow: hidden; touch-action: none; font-family: 'Segoe UI', sans-serif; color: white; user-select: none; -webkit-user-select: none; }
        canvas { display: block; }

        /* UI Katmanları */
        #menu, #game-ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        #menu { background: rgba(5,5,5,0.95); pointer-events: auto; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 20; }
        
        h1 { font-size: 40px; text-shadow: 0 0 20px #bd00ff; margin-bottom: 10px; letter-spacing: 3px; text-align: center; color: #fff; }
        
        button {
            padding: 15px 50px; margin: 10px; font-size: 18px; font-weight: bold;
            border: none; border-radius: 8px; cursor: pointer; width: 260px;
            text-transform: uppercase; transition: 0.2s; box-shadow: 0 0 15px rgba(255,255,255,0.2);
        }
        .btn-host { background: #ff0055; color: #fff; }
        .btn-join { background: #00f2ff; color: #000; }
        button:active { transform: scale(0.95); }

        input {
            padding: 15px; font-size: 24px; border-radius: 8px; border: 2px solid #444;
            background: #111; color: #00f2ff; text-align: center; margin-bottom: 15px; width: 220px; outline: none; letter-spacing: 5px;
        }

        /* Oyun İçi Barlar */
        .bar-container { position: absolute; width: 100px; height: 8px; background: #333; border-radius: 4px; }
        #p1-bar { top: 20px; left: 20px; } /* Host HP */
        #p1-energy { top: 35px; left: 20px; height: 4px; width: 80px; } /* Host Energy */
        
        #p2-bar { bottom: 20px; right: 20px; } /* Client HP */
        #p2-energy { bottom: 35px; right: 20px; height: 4px; width: 80px; } /* Client Energy */

        .fill { height: 100%; border-radius: 4px; transition: width 0.1s; }
        .hp-fill { background: #ff0055; box-shadow: 0 0 10px #ff0055; }
        .en-fill { background: #00f2ff; box-shadow: 0 0 10px #00f2ff; }

        #msg-box {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 24px; color: #fff; text-shadow: 0 0 10px #fff; display: none;
        }
    </style>
</head>
<body>

    <div id="game-ui" style="display:none;">
        <div id="p1-bar" class="bar-container"><div id="p1-hp" class="fill hp-fill" style="width:100%"></div></div>
        <div id="p1-energy" class="bar-container"><div id="p1-en" class="fill en-fill" style="width:100%"></div></div>
        
        <div id="p2-bar" class="bar-container"><div id="p2-hp" class="fill hp-fill" style="width:100%; background:#00f2ff; box-shadow:0 0 10px #00f2ff;"></div></div>
        <div id="p2-energy" class="bar-container"><div id="p2-en" class="fill en-fill" style="width:100%; background:#ff0055; box-shadow:0 0 10px #ff0055;"></div></div>
        
        <div id="msg-box">BEKLENİYOR...</div>
    </div>

    <div id="menu">
        <h1>NEON DUEL <span style="font-size:16px; display:block; color:#888; margin-top:5px;">V2: SMOOTH</span></h1>
        
        <div id="start-panel">
            <button class="btn-host" onclick="initHost()">ODA KUR (SALDIRAN)</button>
            <br>
            <button class="btn-join" onclick="showJoin()">ODAYA GİR (SAVUNAN)</button>
        </div>

        <div id="join-panel" style="display:none; flex-direction:column; align-items:center;">
            <input type="text" id="room-code" placeholder="1234" maxlength="4" type="number">
            <button class="btn-join" onclick="initClient()">BAĞLAN</button>
            <button style="background:transparent; border:1px solid #555; color:#aaa; margin-top:10px; font-size:14px;" onclick="location.reload()">GERİ</button>
        </div>

        <div id="lobby-panel" style="display:none; text-align:center;">
            <p style="color:#aaa;">ARKADAŞINA BU KODU VER:</p>
            <div id="my-code" style="font-size:60px; color:#ff0055; font-weight:bold; letter-spacing:10px; margin:20px 0;">...</div>
            <p class="pulse">Rakip bekleniyor...</p>
        </div>
    </div>

    <canvas id="c"></canvas>

    <script>
        // --- AYARLAR ---
        const c = document.getElementById('c');
        const ctx = c.getContext('2d');
        let w, h;
        
        // Oyun Durumu (Senkronize Edilecek Ana Veri)
        // Hedeflenen değerler (Yumuşak geçiş için)
        let targetP1 = 0.5, targetP2 = 0.5;
        
        let game = {
            p1: 0.5, // Host Konum (0-1)
            p2: 0.5, // Client Konum (0-1)
            hp1: 100, en1: 100, // Host Can/Enerji
            hp2: 100, en2: 100, // Client Can/Enerji
            bullets: [], // Mermiler {x, y, vy}
            particles: [] // Efektler (Ağ trafiği yapmaz, lokal çalışır)
        };

        let role = ''; // 'host' or 'client'
        let peer, conn;
        let lastTime = 0;
        let isGameRunning = false;
        let shake = 0;

        // --- EKRAN AYARLARI ---
        function resize(){ w=c.width=window.innerWidth; h=c.height=window.innerHeight; }
        window.addEventListener('resize', resize); resize();

        // --- PEERJS (AĞ) ---
        function generateCode() { return Math.floor(1000 + Math.random() * 9000); }

        function initHost() {
            const code = generateCode();
            document.getElementById('start-panel').style.display = 'none';
            document.getElementById('lobby-panel').style.display = 'block';
            document.getElementById('my-code').innerText = code;

            peer = new Peer(code.toString());
            peer.on('open', id => console.log('Oda:', id));
            peer.on('connection', c => {
                conn = c;
                setupConn();
                startGame('host');
            });
        }

        function showJoin() {
            document.getElementById('start-panel').style.display = 'none';
            document.getElementById('join-panel').style.display = 'flex';
        }

        function initClient() {
            const code = document.getElementById('room-code').value;
            if(!code) return;
            peer = new Peer();
            peer.on('open', () => {
                conn = peer.connect(code);
                conn.on('open', () => {
                    setupConn();
                    startGame('client');
                });
            });
        }

        function setupConn() {
            conn.on('data', data => {
                // --- VERİ ALIMI ---
                if(role === 'client' && data.type === 'state') {
                    // Client, Host'tan tüm oyun durumunu alır
                    // Ama kendi pozisyonunu ezmez, onu kendi kontrol eder
                    game.p1 = data.state.p1; // Rakibin konumu (kesin)
                    
                    // Mermileri ve canları senkronize et
                    game.bullets = data.state.bullets;
                    game.hp1 = data.state.hp1; game.hp2 = data.state.hp2;
                    game.en1 = data.state.en1; game.en2 = data.state.en2;

                    // Patlama efekti emri geldiyse
                    if(data.boom) createExplosion(data.boom.x * w, data.boom.y * h, data.boom.color);
                } 
                else if(role === 'host' && data.type === 'input') {
                    // Host, Client'tan sadece hedef pozisyonu ve aksiyonu alır
                    targetP2 = data.pos; 
                    if(data.action === 'dash' && game.en2 > 30) {
                        // Client dash atmak istiyor
                        // Host tarafında mantığı işle
                    }
                }
            });
            
            conn.on('close', () => { alert("Bağlantı Koptu!"); location.reload(); });
        }

        // --- OYUN MOTORU ---
        function startGame(r) {
            role = r;
            document.getElementById('menu').style.display = 'none';
            document.getElementById('game-ui').style.display = 'block';
            
            // Bilgi Mesajı
            const msg = document.getElementById('msg-box');
            msg.style.display = 'block';
            msg.innerHTML = role === 'host' ? 
                "<span style='color:#ff0055'>SALDIRANSIN</span><br><span style='font-size:16px'>Dokunarak Ateş Et</span>" : 
                "<span style='color:#00f2ff'>SAVUNANSIN</span><br><span style='font-size:16px'>Mermilerden Kaç / Blokla</span>";
            
            setTimeout(() => msg.style.display = 'none', 3000);

            isGameRunning = true;
            loop();

            // Ağ Döngüsü (Saniyede 20 kez veri gönder - Lag önlemek için 60fps gönderme!)
            setInterval(() => {
                if(!isGameRunning) return;
                if(role === 'host') {
                    conn.send({ type: 'state', state: game });
                } else {
                    conn.send({ type: 'input', pos: targetP2 }); // Client sadece kendi hedefini gönderir
                }
            }, 50); 
        }

        function update(dt) {
            // --- YUMUŞATMA (INTERPOLATION) ---
            // Hedef konuma yavaşça git (Lag olsa bile akıcı görünür)
            if(role === 'host') {
                // Host zaten p1'i kontrol ediyor, p2'yi yumuşat
                game.p2 += (targetP2 - game.p2) * 0.2;
                game.p1 += (targetP1 - game.p1) * 0.2; 
            } else {
                // Client p2'yi kontrol ediyor, p1'i yumuşat (Network'ten gelen)
                game.p2 += (targetP2 - game.p2) * 0.2;
                // p1 zaten networkten akıcı geliyor (Host p1'i yumuşatıp yollamıyor, anlık yolluyor, burada yumuşatabiliriz)
            }

            // Sınırlar
            game.p1 = Math.max(0.05, Math.min(0.95, game.p1));
            game.p2 = Math.max(0.05, Math.min(0.95, game.p2));

            // Enerji Dolumu
            if(game.en1 < 100) game.en1 += 0.5;
            if(game.en2 < 100) game.en2 += 0.5;

            // SADECE HOST MANTIĞI HESAPLAR (Hile olmaması için)
            if(role === 'host') {
                // Mermi Hareketi
                for(let i=game.bullets.length-1; i>=0; i--) {
                    let b = game.bullets[i];
                    b.y += 0.02; // %2 hızla aşağı in

                    // Çarpışma (Client'a Değdi mi?)
                    // Client y: 0.9, Genişlik: 0.15
                    if(b.y > 0.88 && b.y < 0.92) {
                        if(Math.abs(b.x - game.p2) < 0.08) { // Kalkan genişliği
                            // BLOKE EDİLDİ (Kalkan vuruşu)
                            game.bullets.splice(i, 1);
                            createExplosion(b.x * w, b.y * h, '#00f2ff');
                            conn.send({type:'state', state:game, boom:{x:b.x, y:b.y, color:'#00f2ff'}});
                            shake = 5;
                            continue;
                        }
                    }

                    // Vücut Vuruşu (Can yakar)
                    if(b.y > 1.0) {
                        game.hp2 -= 10; // Savunan hasar alır
                        game.bullets.splice(i, 1);
                        shake = 10;
                        if(game.hp2 <= 0) endGame("SALDIRAN KAZANDI!");
                    }
                }
            }

            // UI Güncelleme
            document.getElementById('p1-hp').style.width = game.hp1 + "%";
            document.getElementById('p1-en').style.width = game.en1 + "%";
            document.getElementById('p2-hp').style.width = game.hp2 + "%";
            document.getElementById('p2-en').style.width = game.en2 + "%";
        }

        function draw() {
            // Ekran Temizle
            ctx.fillStyle = '#050505'; ctx.fillRect(0,0,w,h);
            
            // Shake Efekti
            ctx.save();
            if(shake > 0) {
                ctx.translate((Math.random()-0.5)*shake, (Math.random()-0.5)*shake);
                shake *= 0.9;
            }

            // Izgara
            ctx.strokeStyle = '#111'; ctx.beginPath();
            for(let i=0; i<w; i+=50) { ctx.moveTo(i,0); ctx.lineTo(i,h); }
            ctx.stroke();

            // --- OYUNCULAR ---
            
            // Host (Saldıran - Üst)
            let x1 = game.p1 * w;
            ctx.fillStyle = '#ff0055';
            ctx.shadowBlur = 20; ctx.shadowColor = '#ff0055';
            ctx.beginPath(); ctx.moveTo(x1, h*0.1+20); ctx.lineTo(x1-20, h*0.1-20); ctx.lineTo(x1+20, h*0.1-20); ctx.fill();
            
            // Client (Savunan - Alt)
            let x2 = game.p2 * w;
            ctx.fillStyle = '#00f2ff';
            ctx.shadowBlur = 20; ctx.shadowColor = '#00f2ff';
            ctx.fillRect(x2 - w*0.075, h*0.9 - 10, w*0.15, 20); // Geniş kalkan

            // Mermiler
            ctx.fillStyle = '#fff'; ctx.shadowBlur = 10; ctx.shadowColor = '#fff';
            for(let b of game.bullets) {
                ctx.beginPath(); ctx.arc(b.x * w, b.y * h, 6, 0, Math.PI*2); ctx.fill();
            }
            ctx.shadowBlur = 0;

            // Efektler
            for(let i=game.particles.length-1; i>=0; i--) {
                let p = game.particles[i];
                p.x += p.vx; p.y += p.vy; p.life -= 0.05;
                ctx.fillStyle = p.color; ctx.globalAlpha = p.life;
                ctx.beginPath(); ctx.arc(p.x, p.y, Math.random()*4, 0, Math.PI*2); ctx.fill();
                if(p.life <= 0) game.particles.splice(i,1);
            }
            ctx.globalAlpha = 1;
            ctx.restore();
        }

        function loop() {
            if(!isGameRunning) return;
            requestAnimationFrame(loop);
            update();
            draw();
        }

        function endGame(msg) {
            isGameRunning = false;
            alert(msg);
            location.reload();
        }

        function createExplosion(x, y, color) {
            for(let i=0; i<15; i++) {
                game.particles.push({
                    x:x, y:y, color:color,
                    vx:(Math.random()-0.5)*10, vy:(Math.random()-0.5)*10, life:1
                });
            }
        }

        // --- GİRDİ KONTROLÜ (DOKUNMATİK & MOUSE) ---
        
        function handleInput(e) {
            if(!isGameRunning) return;
            e.preventDefault(); // Kaydırmayı engelle
            
            let cx = e.touches ? e.touches[0].clientX : e.clientX;
            let val = cx / w;

            if(role === 'host') {
                targetP1 = val; // Kendi hedefini güncelle
            } else {
                targetP2 = val; // Kendi hedefini güncelle
            }
        }

        function handleAction(e) {
            if(!isGameRunning) return;
            // Ateş Etme (Sadece Host)
            if(role === 'host' && game.en1 >= 20) {
                game.bullets.push({x: game.p1, y: 0.12});
                game.en1 -= 20; // Enerji harca
                // Sesi burada çalabilirsin
            }
        }

        // Event Listeners
        window.addEventListener('mousemove', handleInput);
        window.addEventListener('touchmove', handleInput, {passive:false});
        
        window.addEventListener('mousedown', handleAction);
        window.addEventListener('touchstart', handleAction, {passive:false});

    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NEON DUEL: ONLINE</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; background: #050505; overflow: hidden; touch-action: none; font-family: 'Segoe UI', sans-serif; color: white; user-select: none; }
        canvas { display: block; }

        /* ArayÃ¼z */
        #menu {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 10;
        }
        h1 { font-size: 40px; color: #fff; text-shadow: 0 0 20px #00f2ff; margin-bottom: 10px; letter-spacing: 2px; text-align: center; }
        p { color: #aaa; margin-bottom: 30px; text-align: center; max-width: 300px; }

        .btn {
            padding: 15px 40px; margin: 10px; font-size: 20px; font-weight: bold;
            border: none; border-radius: 30px; cursor: pointer; width: 250px;
            text-transform: uppercase; transition: 0.2s;
        }
        .btn-host { background: #ff0055; color: white; box-shadow: 0 0 20px #ff0055; }
        .btn-join { background: #00f2ff; color: black; box-shadow: 0 0 20px #00f2ff; }
        .btn:active { transform: scale(0.95); }

        input {
            padding: 15px; font-size: 20px; border-radius: 10px; border: 2px solid #00f2ff;
            background: transparent; color: white; text-align: center; margin-bottom: 10px; width: 220px; outline: none;
        }

        #status-msg { margin-top: 20px; font-size: 16px; color: #ffd700; height: 30px; }
        
        /* Oyun Ä°Ã§i UI */
        #game-ui { position: absolute; top: 10px; left: 10px; pointer-events: none; display: none; }
        .role-badge { padding: 5px 10px; border-radius: 5px; font-weight: bold; font-size: 18px; }
    </style>
</head>
<body>

    <div id="game-ui">
        <div id="role-disp" class="role-badge">YÃœKLENÄ°YOR...</div>
        <div style="margin-top:5px;">CAN: <span id="hp-val">100</span></div>
    </div>

    <div id="menu">
        <h1>NEON DUEL</h1>
        <p>Bir kiÅŸi "ODA KUR" desin, diÄŸeri verilen kodu girip "KATIL" desin.</p>
        
        <div id="initial-btns">
            <button class="btn btn-host" onclick="createRoom()">ODA KUR (SALDIRAN)</button>
            <br>
            <button class="btn btn-join" onclick="showJoinInput()">KATIL (SAVUNAN)</button>
        </div>

        <div id="join-area" style="display:none; flex-direction:column; align-items:center;">
            <input type="text" id="room-code-input" placeholder="ODA KODUNU GÄ°R" maxlength="6">
            <button class="btn btn-join" onclick="joinRoom()">BAÄžLAN</button>
            <button class="btn" style="background:transparent; color:#aaa; margin-top:10px;" onclick="backToMenu()">GERÄ°</button>
        </div>

        <div id="status-msg"></div>
        <div id="room-code-display" style="display:none; margin-top:20px; font-size:30px; color:#00f2ff; border:2px dashed #00f2ff; padding:10px;">
            KOD: <span id="code-val">...</span>
        </div>
    </div>

    <canvas id="c"></canvas>

    <script>
        const c = document.getElementById('c');
        const ctx = c.getContext('2d');
        let w, h;
        
        // --- OYUN DEÄžÄ°ÅžKENLERÄ° ---
        let peer = null;
        let conn = null;
        let myRole = null; // 'host' (SaldÄ±ran) veya 'client' (Savunan)
        let gameActive = false;
        
        // Durumlar (Senkronize edilecek)
        let gameState = {
            p1: 0.5, // Host konumu (0.0 - 1.0 arasÄ±, ekran yÃ¼zdesi)
            p2: 0.5, // Client konumu
            bullets: [],
            hp: 100,
            winner: null
        };

        // Kendi konumumuzu tutalÄ±m (Fare/Parmak)
        let myPos = 0.5;

        function resize(){ w=c.width=window.innerWidth; h=c.height=window.innerHeight; }
        window.addEventListener('resize', resize); resize();

        // --- PEERJS (BAÄžLANTI) ---

        // Rastgele 4 haneli kod Ã¼ret
        function generateID() {
            return Math.floor(1000 + Math.random() * 9000).toString();
        }

        function createRoom() {
            document.getElementById('initial-btns').style.display = 'none';
            document.getElementById('status-msg').innerText = "Sunucu oluÅŸturuluyor...";
            
            const code = generateID();
            // Peer nesnesi oluÅŸtur
            peer = new Peer(code);

            peer.on('open', (id) => {
                document.getElementById('status-msg').innerText = "Oda hazÄ±r! ArkadaÅŸÄ±na bu kodu sÃ¶yle:";
                document.getElementById('room-code-display').style.display = 'block';
                document.getElementById('code-val').innerText = id;
                myRole = 'host';
            });

            peer.on('connection', (connection) => {
                conn = connection;
                setupConnection();
                document.getElementById('menu').style.display = 'none';
                startGame('host');
            });
            
            peer.on('error', (err) => {
                alert("Hata oluÅŸtu: " + err);
                location.reload();
            });
        }

        function showJoinInput() {
            document.getElementById('initial-btns').style.display = 'none';
            document.getElementById('join-area').style.display = 'flex';
        }
        
        function backToMenu() {
            document.getElementById('join-area').style.display = 'none';
            document.getElementById('initial-btns').style.display = 'block';
        }

        function joinRoom() {
            const code = document.getElementById('room-code-input').value;
            if(!code) return alert("LÃ¼tfen kodu gir!");
            
            document.getElementById('status-msg').innerText = "BaÄŸlanÄ±yor...";
            
            peer = new Peer(); // ID otomatik olsun
            peer.on('open', () => {
                conn = peer.connect(code);
                
                conn.on('open', () => {
                    myRole = 'client';
                    setupConnection();
                    document.getElementById('menu').style.display = 'none';
                    startGame('client');
                });
                
                // BaÄŸlantÄ± hatasÄ± olursa 2 saniye sonra
                setTimeout(() => {
                    if(!gameActive) document.getElementById('status-msg').innerText = "BaÄŸlanamadÄ±. Kodu kontrol et.";
                }, 3000);
            });
        }

        function setupConnection() {
            // Veri geldiÄŸinde ne yapacaÄŸÄ±mÄ±z
            conn.on('data', (data) => {
                if(myRole === 'client') {
                    // EÄŸer Savunansak, Host'tan gelen oyun durumunu alÄ±rÄ±z
                    if(data.type === 'state') {
                        gameState = data.state;
                    }
                } else if(myRole === 'host') {
                    // EÄŸer SaldÄ±ransak, Client'Ä±n sadece pozisyonunu alÄ±rÄ±z
                    if(data.type === 'input') {
                        gameState.p2 = data.pos;
                    }
                }
            });

            conn.on('close', () => {
                alert("BaÄŸlantÄ± koptu!");
                location.reload();
            });
        }

        // --- OYUN MANTIÄžI ---

        function startGame(role) {
            gameActive = true;
            document.getElementById('game-ui').style.display = 'block';
            const badge = document.getElementById('role-disp');
            
            if(role === 'host') {
                badge.innerText = "ðŸ”´ SEN: SALDIRAN (ÃœST)";
                badge.style.background = "#ff0055";
                badge.style.color = "white";
            } else {
                badge.innerText = "ðŸ”µ SEN: SAVUNAN (ALT)";
                badge.style.background = "#00f2ff";
                badge.style.color = "black";
            }
            
            loop();
            
            // Host ise dÃ¼zenli olarak veri gÃ¶ndersin
            if(role === 'host') {
                setInterval(serverTick, 30); // Saniyede ~30 gÃ¼ncelleme
                setInterval(autoShoot, 500); // YarÄ±m saniyede bir ateÅŸ
            } else {
                setInterval(clientTick, 30);
            }
        }

        // HOST MANTIÄžI (Oyunun beyni burasÄ±)
        function serverTick() {
            if(!gameActive || !conn) return;

            // 1. Kendi pozisyonunu gÃ¼ncelle
            gameState.p1 = myPos;

            // 2. Mermileri hareket ettir
            for (let i = gameState.bullets.length - 1; i >= 0; i--) {
                let b = gameState.bullets[i];
                b.y += 1.5; // Mermi hÄ±zÄ± (yÃ¼zde olarak)

                // Ã‡arpÄ±ÅŸma KontrolÃ¼ (Client ile)
                // Client (p2) altta (y=90%), geniÅŸliÄŸi %15
                if (b.y > 90 && b.y < 95) {
                    if (Math.abs(b.x - gameState.p2) < 0.15/2) { // Kalkan geniÅŸliÄŸi
                        // BLOKE EDÄ°LDÄ°
                        gameState.bullets.splice(i, 1);
                        continue;
                    }
                }

                // Ekrandan Ã§Ä±karsa (VURULDU!)
                if (b.y > 100) {
                    gameState.hp -= 10;
                    gameState.bullets.splice(i, 1);
                }
            }

            // 3. Oyun Bitti mi?
            if(gameState.hp <= 0) {
                gameState.winner = 'host';
                endGame();
            }

            // 4. Veriyi Client'a gÃ¶nder
            conn.send({ type: 'state', state: gameState });
        }
        
        function autoShoot() {
            // Mermi ekle (x: 0-1 arasÄ±, y: 0-100 arasÄ±)
            gameState.bullets.push({ x: gameState.p1, y: 10 });
        }

        // CLIENT MANTIÄžI
        function clientTick() {
            if(!gameActive || !conn) return;
            // Sadece kendi pozisyonumuzu gÃ¶nderiyoruz
            conn.send({ type: 'input', pos: myPos });
            
            // HP kontrolÃ¼ (Sadece gÃ¶rsel gÃ¼ncelleme iÃ§in)
            document.getElementById('hp-val').innerText = gameState.hp;
            if(gameState.hp <= 0) endGame();
        }

        function endGame() {
            gameActive = false;
            setTimeout(() => {
                if(gameState.hp <= 0) alert("SALDIRAN KAZANDI! ðŸ”´");
                location.reload();
            }, 100);
        }

        // --- Ã‡Ä°ZÄ°M ---

        function loop() {
            if(!gameActive) return;
            requestAnimationFrame(loop);

            // Arkaplan
            ctx.fillStyle = '#050505';
            ctx.fillRect(0, 0, w, h);
            
            // Ã‡izgiler (Grid)
            ctx.strokeStyle = '#222';
            ctx.beginPath();
            ctx.moveTo(0, h*0.9); ctx.lineTo(w, h*0.9); // Savunma hattÄ±
            ctx.stroke();

            // --- OYUNCULARI Ã‡Ä°Z (KoordinatlarÄ± %'den Pixel'e Ã§evir) ---
            
            // 1. SALDIRAN (HOST) - ÃœSTTE
            const x1 = gameState.p1 * w;
            const y1 = h * 0.1;
            ctx.fillStyle = '#ff0055';
            ctx.shadowBlur = 20; ctx.shadowColor = '#ff0055';
            // ÃœÃ§gen Gemi
            ctx.beginPath();
            ctx.moveTo(x1, y1 + 20);
            ctx.lineTo(x1 - 20, y1 - 20);
            ctx.lineTo(x1 + 20, y1 - 20);
            ctx.fill();
            ctx.shadowBlur = 0;

            // 2. SAVUNAN (CLIENT) - ALTTA
            const x2 = gameState.p2 * w;
            const y2 = h * 0.9;
            ctx.fillStyle = '#00f2ff';
            ctx.shadowBlur = 20; ctx.shadowColor = '#00f2ff';
            // DikdÃ¶rtgen Kalkan
            const shieldW = w * 0.15; // %15 geniÅŸlik
            ctx.fillRect(x2 - shieldW/2, y2 - 10, shieldW, 20);
            ctx.shadowBlur = 0;

            // 3. MERMÄ°LER
            ctx.fillStyle = '#fff';
            for(let b of gameState.bullets) {
                // Mermi koordinatlarÄ±nÄ± yÃ¼zdeden piksele Ã§evir
                let bx = b.x * w;
                let by = (b.y / 100) * h;
                
                ctx.beginPath();
                ctx.arc(bx, by, 5, 0, Math.PI*2);
                ctx.fill();
            }
        }

        // --- KONTROLLER ---
        function handleInput(e) {
            e.preventDefault();
            let cx = e.touches ? e.touches[0].clientX : e.clientX;
            // 0 ile 1 arasÄ±nda bir deÄŸer yap (Ekran yÃ¼zdesi)
            myPos = cx / w;
            if(myPos < 0) myPos = 0;
            if(myPos > 1) myPos = 1;
        }

        window.addEventListener('mousemove', handleInput);
        window.addEventListener('touchmove', handleInput, {passive:false});

    </script>
</body>
</html>

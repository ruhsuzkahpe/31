<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Render Online XOX</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #2c3e50;
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
        }
        h1 { margin-bottom: 10px; }
        
        /* Bağlantı Paneli Tasarımı */
        #connection-panel {
            background: #34495e;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        input {
            padding: 10px;
            border-radius: 5px;
            border: none;
            margin-top: 10px;
            width: 200px;
        }
        button {
            padding: 10px 20px;
            margin-top: 10px;
            background-color: #27ae60;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover { background-color: #2ecc71; }
        
        /* Oyun Alanı Tasarımı */
        #game-area {
            display: none; /* Başlangıçta gizli */
            flex-direction: column;
            align-items: center;
        }
        .status {
            margin-bottom: 20px;
            font-size: 1.2em;
            font-weight: bold;
            padding: 10px;
            background: #34495e;
            border-radius: 5px;
        }
        .board {
            display: grid;
            grid-template-columns: repeat(3, 100px);
            grid-template-rows: repeat(3, 100px);
            gap: 5px;
        }
        .cell {
            width: 100px;
            height: 100px;
            background-color: #ecf0f1;
            color: #2c3e50;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3em;
            font-weight: bold;
            cursor: pointer;
            border-radius: 5px;
        }
        .cell:hover { background-color: #bdc3c7; }
        .winner { background-color: #f1c40f !important; color: #fff; }
    </style>
</head>
<body>

    <h1>Online XOX Oyunu</h1>

    <div id="connection-panel">
        <p>Senin ID Numaran:</p>
        <h3 id="my-id" style="color: #f1c40f;">Yükleniyor...</h3>
        <hr style="border-color: #7f8c8d;">
        <p>Arkadaşının ID Numarasını Gir:</p>
        <input type="text" id="friend-id-input" placeholder="Arkadaşının ID'sini yapıştır">
        <br>
        <button onclick="connectToFriend()">Oyuna Bağlan</button>
        <p id="status-msg" style="font-size: 0.9em; color: #bdc3c7; margin-top: 10px;">ID bekleniyor...</p>
    </div>

    <div id="game-area">
        <div id="game-status" class="status">Sıra bekleniyor...</div>
        <div class="board" id="board">
            <div class="cell" data-index="0"></div>
            <div class="cell" data-index="1"></div>
            <div class="cell" data-index="2"></div>
            <div class="cell" data-index="3"></div>
            <div class="cell" data-index="4"></div>
            <div class="cell" data-index="5"></div>
            <div class="cell" data-index="6"></div>
            <div class="cell" data-index="7"></div>
            <div class="cell" data-index="8"></div>
        </div>
        <button onclick="location.reload()" style="background-color: #c0392b; margin-top: 20px;">Oyundan Çık / Yenile</button>
    </div>

    <script>
        // PeerJS Kurulumu
        const peer = new Peer(); 
        let conn;
        let myId = null;
        let mySymbol = 'X'; // Oyunu başlatan X olur
        let turn = false;   // Sıra kimde?
        let gameActive = true;
        const boardState = ['', '', '', '', '', '', '', '', ''];

        const statusMsg = document.getElementById('status-msg');
        const gameStatus = document.getElementById('game-status');
        const cells = document.querySelectorAll('.cell');

        // 1. PeerJS ID Alındığında
        peer.on('open', (id) => {
            myId = id;
            document.getElementById('my-id').innerText = id;
            statusMsg.innerText = "Bu ID'yi arkadaşına gönder.";
        });

        // 2. Birisi bize bağlandığında (Arkadaşın ID'yi girdiğinde)
        peer.on('connection', (connection) => {
            conn = connection;
            setupConnection();
            mySymbol = 'O'; // Bağlanan kişi O olur
            turn = false;   // İlk bağlanan beklemede kalır, kuran başlar
            startGame("Arkadaşın bağlandı! O (X) olarak başlayacak.");
        });

        // 3. Biz bağlan butonuna bastığımızda
        function connectToFriend() {
            const friendId = document.getElementById('friend-id-input').value;
            if (!friendId) return alert("Lütfen bir ID girin!");
            
            conn = peer.connect(friendId);
            setupConnection();
            mySymbol = 'X'; // Bağlantıyı başlatan X olur
            turn = true;    // İlk hamleyi yapan
            startGame("Bağlanıldı! Sen (X) olarak başlıyorsun.");
        }

        // Bağlantı Ayarları ve Veri Dinleme
        function setupConnection() {
            // Veri geldiğinde (Karşı taraf hamle yaptığında)
            conn.on('data', (data) => {
                if (data.type === 'move') {
                    handleRemoteMove(data.index, data.symbol);
                }
            });

            conn.on('open', () => {
                console.log("Bağlantı açık!");
            });
        }

        function startGame(msg) {
            document.getElementById('connection-panel').style.display = 'none';
            document.getElementById('game-area').style.display = 'flex';
            updateStatus();
            if(msg) alert(msg);
        }

        // Hücrelere Tıklama Olayı
        cells.forEach(cell => {
            cell.addEventListener('click', () => {
                const index = cell.getAttribute('data-index');
                
                // Eğer sıra bizde değilse veya oyun bittiyse veya hücre doluysa
                if (!turn || !gameActive || boardState[index] !== '') return;

                // Hamleyi yap
                makeMove(index, mySymbol);
                
                // Hamleyi karşıya gönder
                if(conn) {
                    conn.send({ type: 'move', index: index, symbol: mySymbol });
                }

                turn = false; // Sırayı devret
                updateStatus();
            });
        });

        // Uzaktan gelen hamleyi işleme
        function handleRemoteMove(index, symbol) {
            makeMove(index, symbol);
            turn = true; // Sıra bize geçti
            updateStatus();
        }

        // Tahtayı güncelleme mantığı
        function makeMove(index, symbol) {
            boardState[index] = symbol;
            cells[index].innerText = symbol;
            cells[index].style.color = symbol === 'X' ? '#e74c3c' : '#3498db';
            checkWin();
        }

        function updateStatus() {
            if (!gameActive) return;
            gameStatus.innerText = turn ? `Sıra Sende (${mySymbol})` : "Arkadaşının Hamlesi Bekleniyor...";
            gameStatus.style.backgroundColor = turn ? "#27ae60" : "#e67e22";
        }

        // Kazanma Kontrolü
        function checkWin() {
            const winConditions = [
                [0, 1, 2], [3, 4, 5], [6, 7, 8], // Yatay
                [0, 3, 6], [1, 4, 7], [2, 5, 8], // Dikey
                [0, 4, 8], [2, 4, 6]             // Çapraz
            ];

            let roundWon = false;
            let winningCells = [];

            for (let i = 0; i < winConditions.length; i++) {
                const [a, b, c] = winConditions[i];
                if (boardState[a] && boardState[a] === boardState[b] && boardState[a] === boardState[c]) {
                    roundWon = true;
                    winningCells = [a, b, c];
                    break;
                }
            }

            if (roundWon) {
                gameActive = false;
                gameStatus.innerText = turn ? "Kaybettin!" : "Kazandın!"; // Turn tersine döndüğü için mantık burda biraz karışabilir ama son hamleyi yapan kazanır.
                // Düzeltme: makeMove sonrası turn değişmeden burası çalışırsa:
                // Eğer ben hamle yaptıysam ve kazandıysam, sıra henüz devredilmemiştir.
                // Ancak kod akışında makeMove sonrası turn değişiyor.
                // Basit kontrol: Son sembol kiminse o kazandı.
                
                // Renklendirme
                winningCells.forEach(index => cells[index].classList.add('winner'));
                alert("Oyun Bitti!");
                return;
            }

            if (!boardState.includes('')) {
                gameActive = false;
                gameStatus.innerText = "Berabere!";
                alert("Berabere!");
            }
        }
    </script>
</body>
</html>
